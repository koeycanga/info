/**
 * Copyright 2018 畅云 http://www.ichangyun.cn
 * <p>
 * 竞争情报分析系统
 */
package com.ichangyun.InforAnalyaizer.controller.thematicmonitoring;

import java.util.Date;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.ModelAndView;

import com.ichangyun.InforAnalyaizer.common.DateUtils;
import com.ichangyun.InforAnalyaizer.model.thematicmonitoring.ArticleInfoBean;
import com.ichangyun.InforAnalyaizer.service.thematicmonitoring.ThematicmonitoringService;

/**
 * 专题监测Controller
 * @author renhao 
 * 2018-11-12 14:52
 */

@RestController
@RequestMapping("/thematicmonitoring")
public class ThematicmonitoringController {

	@Autowired
	private ThematicmonitoringService thematicmonitoringService;
	
	
	/**
	 * 进入到专题监测-信息汇总页面
	 * @return
	 */
	@RequestMapping("/informationaggregation")
	@ResponseBody
	public Object index() {
		return new ModelAndView("thematicmonitoring/informationaggregation");
	}
	
	
	/**
	 * 获得所有的方案
	 * @return
	 */
	@RequestMapping("/getallfa")
	public Object getAllFA() {
		
		String json = thematicmonitoringService.getAllFA();
		
		return json;
	}
	
	/**
	 * 保存新的方案
	 * @param planinfo_name  //方案名称
	 * @param jcc_json       //方案监测词JSON字面量
	 * @param session
	 * @return
	 */
	@RequestMapping("/savenewfa")
	public Object SaveNewfa(@RequestBody Map map,HttpSession session) {
		
		String res = "ok";
		
		String planinfo_name  = (String) map.get("planinfo_name");
		String jcc_json  = (String) map.get("jcc_json");
		String planinfo_removeWord  = (String) map.get("planinfo_removeWord");
		planinfo_removeWord = planinfo_removeWord.replace("，", ",");
		if(thematicmonitoringService.exist(planinfo_name)) {
			res = "exist";
		}else {
			if(!thematicmonitoringService.SaveNewfa(planinfo_name,jcc_json,planinfo_removeWord,session)) {
				res = "nok";
			}
		}
		return res;
		
	}
	
	/**
	 * 预警文章
	 * @param map
	 * @param session
	 * @return
	 */
	@RequestMapping("/toyj")
	public Object toyj(@RequestBody Map map,HttpSession session) {
		String res = "ok";
		
		String json = (String) map.get("json");
		
		if(!thematicmonitoringService.toyj(json,session)) {
			res = "nok"; 
		}
		
		return res;
	}
	
	
	@RequestMapping("/delarticle")
	public Object delarticle(@RequestBody Map map) {
		String res = "ok";
		String json = (String) map.get("json");
		if(!thematicmonitoringService.delarticle(json)) {
			res = "nok"; 
		}
		return res;
	}
	
	@RequestMapping("/updatefa")
	public Object updatefa(@RequestBody Map map,HttpSession session) {
		String res = "ok";
		
		String plan_id  = (String) map.get("plan_id");
		String planinfo_name  = (String) map.get("planinfo_name");
		String jcc_json  = (String) map.get("jcc_json");
		String planinfo_removeWord  = (String) map.get("planinfo_removeWord");
		planinfo_removeWord = planinfo_removeWord.replace("，", ",");
		if(thematicmonitoringService.existwithID(plan_id,planinfo_name)) {
			 res = "exist";
		}else {
			
			if(!thematicmonitoringService.updatefa(plan_id,planinfo_name,jcc_json,planinfo_removeWord,session)) {
				res = "nok";
			}
		}
		
		return res;
	}
	
	/**
	 * 删除方案
	 * @param planid 要删除的方案ID 
	 * @return ok 删除成功  nok  删除失败
	 */
	@RequestMapping("/delfa")
	public Object delfa(String planid) {
		String res = "ok";
		
		if(!thematicmonitoringService.delfa(planid)) {
			res = "nok";
		}
		
		return res;
	}
	
	@RequestMapping("/getDetail")
	public Object getDetail(String planid) {
		
		String json = thematicmonitoringService.getDetail(planid);
		
		return json;
	}
	
	
	
	@RequestMapping("/search")
	public Object search(ArticleInfoBean ab) {
		
		//System.out.println(ab.toString());
		
		String[] montime = dealMontime(ab.getMontime());
		
		ab.setMontime_start(montime[0]);
		ab.setMontime_end(montime[1]);
		
		int rowCount = thematicmonitoringService.getArticleRowCount(ab);
		
		String json_res = thematicmonitoringService.getArticleJSON(ab);
		
		String res = "{\"rowCount\":\""+rowCount+"\",\"resdata\":"+json_res+"}";
		
		return res;

	}


	private String[] dealMontime(String montime) {
		
		String[] str = new String[2];
		
		if(montime.equals("0")) {  //今天
			String today = DateUtils.format(new Date(),DateUtils.DATE_PATTERN);
			str[0] = today+" 00:00:00";
			str[1] = today+" 23:59:59";
		}
		
		if(montime.equals("-1")) {  //24小时内
			Date cur_date = new Date();
			Date pre_date = DateUtils.addDateHours(cur_date,-24);
			str[0] = DateUtils.format(pre_date,DateUtils.DATE_TIME_PATTERN);
			str[1] = DateUtils.format(cur_date,DateUtils.DATE_TIME_PATTERN);
		}
		
		if(montime.equals("-2")||montime.equals("-3")||montime.equals("-7")||montime.equals("-10")) {  //2 3 7 10 天内
			Date cur_date = new Date();
			Date pre_date = DateUtils.addDateDays(cur_date, Integer.parseInt(montime));
			str[0] = DateUtils.format(pre_date,DateUtils.DATE_PATTERN+" 00:00:00");
			str[1] = DateUtils.format(cur_date,DateUtils.DATE_TIME_PATTERN);
		}
		
		if(montime.equals("10")) { //自定义
			String[] ss  = montime.split("-");
			str[0] = ss+" 00:00:00";
			str[1] = ss+" 23:59:59";
		}
		
		
		
		return str;
	}
	
}
