<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ichangyun.InforAnalyaizer.mapper.classification.ClassificationInfoMapper">
    <select id="getClassifcInfoCount" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="java.lang.Integer">
         select count(*) from m_classificationinfo where 1=1 
          <if test="cb.ClassificationName!= null and cb.ClassificationName!=''">
			     and ClassificationName like CONCAT('%',#{cb.ClassificationName},'%')
		  </if>
		  <if test="cb.ClassificationName==null or cb.ClassificationName==''">
		        and Parent_Classification_ID='0000000000'
		  </if>
    </select>
    
    <select id="getClassifcInfo" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
         select Classification_ID,ClassificationName,Parent_Classification_ID,DisplayOrder,Description,CreateUser,
			DATE_FORMAT(CreateDateTime,'%Y-%m-%d %H:%i:%s') CreateDateTime,UpdateUser,DATE_FORMAT(UpdateDateTime,'%Y-%m-%d %H:%i:%s') UpdateDateTime,
			 (select count(Classification_ID) from m_classificationinfo b where b.Parent_Classification_ID=a.Classification_ID) children_lg
			 from m_classificationinfo a where 1=1 
			 <if test="cb.ClassificationName!= null and cb.ClassificationName!=''">
			     and a.ClassificationName like CONCAT('%',#{cb.ClassificationName},'%')
			  </if>
			  <if test="cb.ClassificationName==null or cb.ClassificationName==''">
			        and a.Parent_Classification_ID='0000000000'
			  </if>
			  order by a.DisplayOrder desc
			  limit #{cb.l_pre},#{cb.rowSize}
    </select>
  
  
  <select id="getChildernByID" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
       select Classification_ID,ClassificationName,Parent_Classification_ID,DisplayOrder,Description,CreateUser,
			DATE_FORMAT(CreateDateTime,'%Y-%m-%d %H:%i:%s') CreateDateTime,UpdateUser,DATE_FORMAT(UpdateDateTime,'%Y-%m-%d %H:%i:%s') UpdateDateTime,
			 (select count(Classification_ID) from m_classificationinfo b where b.Parent_Classification_ID=a.Classification_ID) children_lg
			 from m_classificationinfo a where Parent_Classification_ID=#{cb.Classification_ID}
  </select>
  
  <select id="exist" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="java.lang.Integer">
       select count(*) from m_classificationinfo where ClassificationName=#{cb.ClassificationName}
  </select>
  
  <select id="existExceptID" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="java.lang.Integer">
       select count(*) from m_classificationinfo where ClassificationName=#{cb.ClassificationName} and Classification_ID!=#{cb.Classification_ID} 
  </select>
  
   <select id="getDisplayOrder" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="java.lang.Integer">
        select 
		  case when max(DisplayOrder) is null then 0
		else max(DisplayOrder)+1
		  end  DisplayOrder
		from m_classificationinfo where Parent_Classification_ID=#{cb.Parent_Classification_ID} for update
   </select>
  
  <select id="getChildren" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean"  resultType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
      select Classification_ID from m_classificationinfo where Parent_Classification_ID=#{cb.Classification_ID}
  </select>
  
  <insert id="addNew" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
    insert into m_classificationinfo(Classification_ID,ClassificationName,Parent_Classification_ID,DisplayOrder,Description ,CreateUser,CreateDateTime)
      values(#{cb.Classification_ID},#{cb.ClassificationName},#{cb.Parent_Classification_ID},#{cb.DisplayOrder},#{cb.Description} ,#{cb.CreateUser},NOW())
  </insert>
  
  <update id="updateData" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
      
      update m_classificationinfo set ClassificationName=#{cb.ClassificationName}, Description=#{cb.Description},
      UpdateUser=#{cb.UpdateUser},UpdateDateTime=NOW(),CreateDateTime=CreateDateTime
       where Classification_ID=#{cb.Classification_ID}
    
  </update>
  
  
  <delete id="delData" parameterType="com.ichangyun.InforAnalyaizer.model.classification.ClassificationInfoBean">
        delete from m_classificationinfo where Classification_ID=#{cb.Classification_ID}
  </delete>
  
  <update id="updateOrder">
        update m_classificationinfo set DisplayOrder=#{cb.DisplayOrder} where Classification_ID=#{cb.Classification_ID} 
  </update>
  
</mapper>
