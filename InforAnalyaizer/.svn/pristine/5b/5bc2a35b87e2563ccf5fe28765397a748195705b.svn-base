/**
 * Copyright 2018 畅云 http://www.ichangyun.cn
 * <p>
 * 竞争情报分析系统
 */
package com.ichangyun.InforAnalyaizer.service.thematicmonitoring.impl;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.Resource;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionDefinition;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.ichangyun.InforAnalyaizer.mapper.numbercontrol.NumberControlMapper;
import com.ichangyun.InforAnalyaizer.mapper.thematicmonitoring.ThematicmonitoringMapper;
import com.ichangyun.InforAnalyaizer.model.CommBean;
import com.ichangyun.InforAnalyaizer.model.User;
import com.ichangyun.InforAnalyaizer.model.numbercontroll.NumberingcontrolBean;
import com.ichangyun.InforAnalyaizer.model.thematicmonitoring.ThematicmonitoringBean;
import com.ichangyun.InforAnalyaizer.service.numberingcontrol.NumberingcontrolService;
import com.ichangyun.InforAnalyaizer.service.thematicmonitoring.ThematicmonitoringService;

/**
 * @author 作者名 <br/>
 * 2018-11-13 10:22
 */
@Service
public class ThematicmonitoringServiceImpl implements ThematicmonitoringService {

	@Autowired
	private ThematicmonitoringMapper thematicmonitoringMapper;

	//采番 Mapper
	@Autowired
	private NumberControlMapper numberControlMapper;
	
	@Autowired
	private NumberingcontrolService numberingcontrolService;
	
	@Resource(name = "transactionManager")
    private PlatformTransactionManager platformTransactionManager;
	
	@Override
	public String getAllFA() {
		
		List<ThematicmonitoringBean> list = thematicmonitoringMapper.getAllFA();
		
		JSONArray listArray=(JSONArray) JSONArray.toJSON(list);

	    return listArray.toJSONString();
	}


	@Override
	public boolean SaveNewfa(String planinfo_name, String jcc_json,String planinfo_removeWord, HttpSession session) {
		
		try {
			String next_pl_id = numberingcontrolService.getNextCFID("NC00000003");
			
			JSONArray ja = JSONArray.parseArray(jcc_json);
			
			User user = (User) session.getAttribute(CommBean.SESSION_NAME);
			String userid = user.getUser_ID();
			
			ThematicmonitoringBean tb = new ThematicmonitoringBean();
			
			tb.setUser_ID(userid);
			tb.setCreateUser(userid);
			tb.setUpdateUser(userid);
			tb.setPlan_ID(next_pl_id);
			tb.setPlanName(planinfo_name);
			tb.setUnitNumber(ja.size());
			
			thematicmonitoringMapper.SaveNewfa(tb);
			
			List<ThematicmonitoringBean> detaillist = new ArrayList<ThematicmonitoringBean>();
			
			for(int i=0;i<ja.size();i++) {
				ThematicmonitoringBean atb = new ThematicmonitoringBean();
				atb.setPlan_ID(next_pl_id);
				atb.setCreateUser(userid);
				atb.setUpdateUser(userid);
				atb.setUnitNo(i+1);
				atb.setRemoveWord(planinfo_removeWord);
				JSONArray obj = (JSONArray) ja.get(i);
				for(int j=0;j<obj.size();j++) {
					JSONObject jobj = (JSONObject) obj.get(j);
					if(j==0) {
						atb.setMonitoringWord1(jobj.getString("jcc"));
					}
					if(j==1) {
						atb.setMonitoringWord2(jobj.getString("jcc"));			
					}
					if(j==2) {
						atb.setMonitoringWord3(jobj.getString("jcc"));
					}
					if(j==3) {
						atb.setMonitoringWord4(jobj.getString("jcc"));
					}
				}
				detaillist.add(atb);
			}
			
			thematicmonitoringMapper.SaveNewfaDetail(detaillist);
			
		}catch(Exception e) {
			return false;
		}
		
		return true;
	}
	
	@Override
	public boolean updatefa(String plan_id, String planinfo_name, String jcc_json, String planinfo_removeWord,HttpSession session) {
		try{
			
			thematicmonitoringMapper.delfadetail(plan_id);
			
			JSONArray ja = JSONArray.parseArray(jcc_json);
	
			User user = (User) session.getAttribute(CommBean.SESSION_NAME);
			String userid = user.getUser_ID();
			
			List<ThematicmonitoringBean> detaillist = new ArrayList<ThematicmonitoringBean>();
			
			for(int i=0;i<ja.size();i++) {
				ThematicmonitoringBean atb = new ThematicmonitoringBean();
				atb.setPlan_ID(plan_id);
				atb.setCreateUser(userid);
				atb.setUpdateUser(userid);
				atb.setUnitNo(i+1);
				atb.setRemoveWord(planinfo_removeWord);
				JSONArray obj = (JSONArray) ja.get(i);
				for(int j=0;j<obj.size();j++) {
					JSONObject jobj = (JSONObject) obj.get(j);
					if(j==0) {
						atb.setMonitoringWord1(jobj.getString("jcc"));
					}
					if(j==1) {
						atb.setMonitoringWord2(jobj.getString("jcc"));			
					}
					if(j==2) {
						atb.setMonitoringWord3(jobj.getString("jcc"));
					}
					if(j==3) {
						atb.setMonitoringWord4(jobj.getString("jcc"));
					}
				}
				detaillist.add(atb);
			}
			
			thematicmonitoringMapper.SaveNewfaDetail(detaillist);
		}catch(Exception e) {
			return false;
		}
		
		return true;
	}


	@Override
	public boolean exist(String planinfo_name) {
		int count = thematicmonitoringMapper.exist(planinfo_name);
		if(count>=1) {
			return true;
		}
		return false;
	}

	@Override
	public boolean existwithID(String plan_id, String planinfo_name) {
		int count = thematicmonitoringMapper.existwithID(plan_id,planinfo_name);
		if(count>=1) {
			return true;
		}
		return false;
	}

	

	@Override
	public boolean delfa(String planid) {
		
		try {
			thematicmonitoringMapper.delfa(planid);
			thematicmonitoringMapper.delfadetail(planid);
			
		}catch(Exception e) {
			return false;
		}
		return true;
	}


	@Override
	public String getDetail(String planid) {
		
		List<ThematicmonitoringBean> list = thematicmonitoringMapper.getDetail(planid);
		
		JSONArray listArray=(JSONArray) JSONArray.toJSON(list);

	    return listArray.toJSONString();
	}


}
