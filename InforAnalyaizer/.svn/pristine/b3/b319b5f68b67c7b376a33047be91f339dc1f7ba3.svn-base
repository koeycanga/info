package com.ichangyun.InforAnalyaizer.service.collection.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.ichangyun.InforAnalyaizer.mapper.collection.CollectionTypeMapper;
import com.ichangyun.InforAnalyaizer.mapper.collection.MyCollectionMapper;
import com.ichangyun.InforAnalyaizer.model.BaseBean;
import com.ichangyun.InforAnalyaizer.model.SearchOptBean;
import com.ichangyun.InforAnalyaizer.model.User;
import com.ichangyun.InforAnalyaizer.model.collection.MyCollectionVo;
import com.ichangyun.InforAnalyaizer.service.collection.CollectionService;
import com.ichangyun.InforAnalyaizer.utils.Obj2Map;

@Service
public class CollectionServiceImpl implements CollectionService {
	@Autowired
	private MyCollectionMapper collectionMapper;
	@Autowired
	private CollectionTypeMapper typeMapper;

	@Override
	public List<SearchOptBean> getOpts() {
		// TODO Auto-generated method stub

		return this.collectionMapper.getOpts();
	}

	@Override
	public List<MyCollectionVo> queryAll(MyCollectionVo vo, BaseBean bb, User u) {
		// TODO Auto-generated method stub
		vo.setUserId(u.getUser_ID());
		Map<String, Object> key = new HashMap<>();
		key = Obj2Map.object2Map(vo);
		int l_pre = (bb.getPageNow() - 1) * bb.getRowSize();
		// 查询条件的map参数
		key.put("l_pre", l_pre);
		key.put("rowSize", bb.getRowSize());
		return this.collectionMapper.queryAll(key);
	}

	@Override
	public int queryCount(MyCollectionVo vo, User u) {
		// TODO Auto-generated method stub
		vo.setUserId(u.getUser_ID());
		Map<String, Object> key = new HashMap<>();
		key = Obj2Map.object2Map(vo);
		return this.collectionMapper.queryCount(key);
	}

	@Override
	public String delete(String[] checkedId) {
		// TODO Auto-generated method stub
		MyCollectionVo vo1 = new MyCollectionVo();
		vo1.setKey(checkedId[0]);							//获取当前文件夹信息
		String userid = vo1.getUserId();					//收藏用户信息
		String collectionTypeId = vo1.getCollectiontypeId();//收藏节点信息
		
		String artIds;										//收藏文章id
		List<String> aIds = new ArrayList<>();
		Map<String, String> key = new HashMap<>();
		for (String id : checkedId) {
			MyCollectionVo vo = new MyCollectionVo();
			vo.setKey(id);
			aIds.add(vo.getArticleId());
		}
		
		
		StringBuilder aid = new StringBuilder();			//将所有选中的文章的id做成字符串
		aid.append("'");
		for (int i = 0; i < aIds.size(); i++) {
			if (i < aIds.size() - 1) {
				aid.append(aIds.get(i) + "\',");
			} else {
				aid.append(aIds.get(i) + "\'");
			}
		}
		artIds = aid.toString();
		key.put("userid", userid);
		key.put("collectiontypeid", collectionTypeId);
		key.put("articleId", artIds);
		try {
			this.collectionMapper.delete(key);
		} catch (Exception e) {
			// TODO: handle exception
			return "fault";
		}
		return "ok";
	}

}
