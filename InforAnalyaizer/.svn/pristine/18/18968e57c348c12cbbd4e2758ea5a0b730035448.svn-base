package com.ichangyun.InforAnalyaizer.controller.login;

import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.OutputStream;

import javax.imageio.ImageIO;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.ModelAndView;

import com.ichangyun.InforAnalyaizer.model.CommBean;
import com.ichangyun.InforAnalyaizer.model.User;
import com.ichangyun.InforAnalyaizer.service.UserService;
import com.ichangyun.InforAnalyaizer.utils.ImageUtil;

@RestController
@RequestMapping("/login")
public class LoginController {

	 @Autowired
	 private  UserService userService;
	
	@RequestMapping("/cookies")
    public Object cookie(HttpServletRequest request) {
    	
    	String str = "{";
    	Cookie[] cookies = request.getCookies();//根据请求数据，找到cookie数组
    	String cookie_name = "";
        String cookie_pwd = "";
        if (cookies!=null) {
            for(int i=0;i<cookies.length;i++){
            	if(cookies[i].getName().equals(CommBean.COOKIE_NAME)) {
            		cookie_name="\"username\":"+"\""+cookies[i].getValue()+"\"";
            	}
            	if(cookies[i].getName().equals(CommBean.COOKIE_PWD)) {
            		cookie_pwd = "\"userpwd\":"+"\""+cookies[i].getValue()+"\"";
            	}
            }
        }
        str+=cookie_name+","+cookie_pwd;
        str+="}";
        return str;
    }
    
    @RequestMapping("/login")
    public Object userLogin(String username,String passwd,String checkCode,String isremberusrname,HttpServletRequest request,HttpServletResponse response,HttpSession session) {
    	
    	String res = "ok";
    	
    	String s_checkCode = (String) session.getAttribute("checkCode");
    	
    	if(!checkCode.toUpperCase().equals(s_checkCode.toUpperCase())) {
    		res = "checkCode_n_ok";    //验证码不正确
    	}else {
    		User user = userService.isUserExist(username,passwd);
    		if(user==null) { //用户名或密码错误
    			res = "";
    		}else {   //登录成功
    		    dealSession(user,session);
    		    if(isremberusrname.equals("true")) {  //记住用户
    		    	userService.addCookie(response,user,passwd);
    	    	}else {  //不记住用户
    	    		userService.delCookie(request,response);
    	    	}
    		}
    	}
    	return res;
    }
 
    private void dealSession(User user,HttpSession session) {
    	session.setAttribute(CommBean.SESSION_NAME, user);
    	session.setAttribute("UserInfo.UserID",user.getUser_ID());
    	session.setAttribute("UserInfo.Password", user.getPassword());
    	session.setAttribute("UserInfo.Name",user.getName());
    	session.setAttribute("UserInfo.Department",user.getDepartment());
    	session.setAttribute("UserInfo.Telephone", user.getTelephone());
    	session.setAttribute("UserInfo.EMail", user.getEMail());
    	session.setAttribute("UserInfo.UserRole_ID",user.getUserRole_ID());
    	session.setAttribute("UserInfo.UpdateDateTime",user.getUpdateDateTime());
    	session.setAttribute("UserInfo.UserRoleName", user.getUserRoleName());
    	session.setAttribute("UserInfo.Authority", user.getAuthority());
	}

	@RequestMapping("/toLogin")
    public Object login(HttpServletRequest request,HttpSession session) {

    	request.setAttribute("user",session.getAttribute(CommBean.SESSION_NAME));
    	
    	
    	return new ModelAndView("main");
    }
    
    @RequestMapping("/valicode")
    public void valicode(HttpServletResponse response,HttpSession session) throws IOException {
    	//利用图片工具生成图片
        //第一个参数是生成的验证码，第二个参数是生成的图片
        Object[] objs = ImageUtil.createImage();
        //将验证码存入Session
        session.setAttribute("checkCode",objs[0]);
        //将图片输出给浏览器
        BufferedImage image = (BufferedImage) objs[1];
        response.setContentType("image/png");
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, "png", os);
    }
}
